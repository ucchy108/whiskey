---
name: code-reviewer
description: 変更されたコードに対してバグ検出、リファクタリング提案、OWASPセキュリティチェックを実施するコードレビューSkillです。PR作成前、機能実装完了時に使用されます。
---

# Code Reviewer

変更されたコードに対して、バグ・リファクタリング・セキュリティの3観点でレビューを実施するSkillです。

## 目的

- バグや潜在的な不具合の早期発見
- リファクタリング機会の特定
- OWASP Top 10 に基づくセキュリティチェック
- コードベースの品質維持

## Instructions

### 1. レビュー対象の特定

レビュー開始時に対象ファイルを特定する。

**特定方法（優先順）:**

1. ユーザーが指定したファイル・ディレクトリ
2. git の変更差分（`git diff --name-only` / `git diff --name-only HEAD`）
3. 未追跡ファイル（`git ls-files --others --exclude-standard`）

```bash
# 変更ファイルの一覧取得
git diff --name-only HEAD
git ls-files --others --exclude-standard
```

### 2. レビュー実施

全ての対象ファイルを Read ツールで読み込み、以下の3観点でレビューする。

---

### 観点A: バグ検出

以下のカテゴリでバグを検出する。

#### A-1: ロジックエラー

- 条件分岐の漏れ・誤り
- ループの境界値ミス（off-by-one）
- 早期リターンの欠落
- null/undefined チェックの不足

#### A-2: 型・データの不整合

- 型の不一致（TypeScript の `any` 乱用含む）
- API レスポンスとフロントエンド型定義の乖離
- Date オブジェクトとタイムゾーンの不整合
- 数値精度の問題（浮動小数点比較など）

#### A-3: 状態管理の問題

- React の state 更新が反映されないケース（stale closure）
- useEffect の依存配列の不足・過剰
- メモリリーク（cleanup 関数の欠落）
- 競合状態（race condition）

#### A-4: エラーハンドリング

- try-catch の欠落
- エラー状態の未処理
- Promise の未処理 rejection
- Go の error チェック漏れ

#### A-5: パフォーマンス

- 不要な再レンダリング（React）
- N+1 クエリ（バックエンド）
- 無限ループの可能性
- メモ化すべき高コスト計算

---

### 観点B: リファクタリング

以下の観点でリファクタリング機会を特定する。

#### B-1: プロジェクトルール違反

プロジェクト固有のルールへの準拠を確認する。CLAUDE.md および frontend/CLAUDE.md に定義されたルールを基準とする。

**フロントエンド:**
- カラーコードのハードコード禁止（theme.ts から参照）
- margin 禁止（gap/padding で制御）
- Page 層のみが API 呼び出し・エラー表示を担当
- feature 間の import は index.ts 経由
- テストは Storybook Portable Stories を使用

**バックエンド:**
- Clean Architecture のレイヤー依存方向
- godoc コメントの有無

#### B-2: コードの重複

- 同じロジックが複数箇所に存在
- 共通化すべきユーティリティ
- ただし「3回以上繰り返されない限り抽象化しない」原則を守る

#### B-3: 関数・コンポーネントの肥大化

- 1関数が50行を超える場合、分割を検討
- 1コンポーネントが複数の責務を持っている場合
- カスタムフックへの切り出し候補

#### B-4: 命名の改善

- 意図が伝わらない変数名・関数名
- 略語の乱用
- 一貫性のない命名規則

#### B-5: 不要なコード

- 使われていない import
- デッドコード（到達不能な分岐）
- コメントアウトされたコード

---

### 観点C: OWASP セキュリティチェック

OWASP Top 10 (2021) に基づくセキュリティチェックを実施する。

#### C-1: A01 - アクセス制御の不備

- [ ] 認証が必要なエンドポイントにミドルウェアが設定されているか
- [ ] 他ユーザーのデータにアクセスできないか（IDOR）
- [ ] 権限チェックが適切に行われているか

#### C-2: A02 - 暗号化の失敗

- [ ] パスワードがハッシュ化されているか（bcrypt等）
- [ ] 機密データがログに出力されていないか
- [ ] 環境変数に機密情報がハードコードされていないか
- [ ] HTTPS が強制されているか

#### C-3: A03 - インジェクション

- [ ] SQL インジェクション: パラメータ化クエリ（sqlc）を使用しているか
- [ ] XSS: ユーザー入力が適切にエスケープされているか（React JSX は自動エスケープ）
- [ ] コマンドインジェクション: `exec.Command` 等でユーザー入力を直接使用していないか
- [ ] `dangerouslySetInnerHTML` が使用されていないか

#### C-4: A04 - 安全でない設計

- [ ] 入力値のバリデーションが行われているか
- [ ] ビジネスロジックのバリデーション（負の数量、未来の日付等）
- [ ] レート制限の考慮

#### C-5: A05 - セキュリティ設定のミス

- [ ] CORS 設定が適切か
- [ ] デバッグモードが本番で無効化されているか
- [ ] 不要なエンドポイントが公開されていないか
- [ ] エラーメッセージにスタックトレースが含まれていないか

#### C-6: A06 - 脆弱なコンポーネント

- [ ] 既知の脆弱性を持つライブラリを使用していないか
- [ ] 依存関係が最新か

#### C-7: A07 - 認証の失敗

- [ ] セッション管理が適切か（有効期限、再生成）
- [ ] ログイン試行回数の制限
- [ ] パスワードポリシーの適用

#### C-8: A08 - ソフトウェアとデータの整合性の問題

- [ ] API レスポンスの検証（型チェック）
- [ ] デシリアライズの安全性

#### C-9: A09 - ログとモニタリングの不足

- [ ] セキュリティ関連イベントのログ記録
- [ ] ログに機密情報が含まれていないか

#### C-10: A10 - SSRF

- [ ] ユーザー入力による外部URL取得がないか
- [ ] 内部ネットワークへのアクセス制限

---

### 3. レビュー結果の出力

レビュー結果は以下のフォーマットで出力する。

```markdown
## コードレビュー結果

### 1. バグ

#### BUG-1: [タイトル] (severity: high/medium/low)

**ファイル:** `path/to/file.ts:行番号`

**問題:**
[問題の説明]

**現在のコード:**
```typescript
// 問題のあるコード
```

**修正案:**
```typescript
// 修正後のコード
```

---

### 2. リファクタリング

#### REFACTOR-1: [タイトル] (priority: high/medium/low)

**ファイル:** `path/to/file.ts:行番号`

**現状:**
[現状の説明]

**改善案:**
[改善の説明とコード例]

---

### 3. OWASP セキュリティチェック

| チェック項目 | 結果 | 備考 |
|---|---|---|
| A01 アクセス制御 | OK / NG / N/A | [詳細] |
| A02 暗号化 | OK / NG / N/A | [詳細] |
| A03 インジェクション | OK / NG / N/A | [詳細] |
| A04 安全でない設計 | OK / NG / N/A | [詳細] |
| A05 セキュリティ設定 | OK / NG / N/A | [詳細] |
| A06 脆弱なコンポーネント | OK / NG / N/A | [詳細] |
| A07 認証の失敗 | OK / NG / N/A | [詳細] |
| A08 データ整合性 | OK / NG / N/A | [詳細] |
| A09 ログ・監視 | OK / NG / N/A | [詳細] |
| A10 SSRF | OK / NG / N/A | [詳細] |

---

### まとめ

| 優先度 | 種別 | 内容 |
|---|---|---|
| **High** | Bug/Refactor/Security | [概要] |
| Medium | Bug/Refactor/Security | [概要] |
| Low | Bug/Refactor/Security | [概要] |
```

### 4. Severity / Priority の基準

#### Bug severity

| レベル | 基準 |
|---|---|
| **high** | データ損失、セキュリティ脆弱性、クラッシュ、データ不整合 |
| **medium** | 特定条件で発生する不具合、UX の劣化、エッジケースでの誤動作 |
| **low** | 表示崩れ、軽微な動作不良、将来的に問題になりうるもの |

#### Refactor priority

| レベル | 基準 |
|---|---|
| **high** | プロジェクトルール違反、保守性に大きく影響 |
| **medium** | コード品質の改善、可読性向上 |
| **low** | 好みの問題、微小な改善 |

## 自動起動の条件

以下の場合に自動的にこのSkillを使用します：

1. ユーザーが「レビューして」「コードレビュー」と依頼した時
2. ユーザーが明示的に `/code-reviewer` を実行した時

## 使用するツール

- **Bash**: `git diff`, `git ls-files` でレビュー対象を特定
- **Read**: 対象ファイルの読み込み
- **Grep**: パターン検索（ハードコード検出等）
- **Glob**: ファイル検索

## 注意事項

- **事実ベース**: 推測ではなく、コードから確認できる問題のみを指摘する
- **修正案を提示**: 問題の指摘だけでなく、具体的な修正案を示す
- **過剰な指摘を避ける**: 重要な問題に集中し、些末な指摘は控える
- **プロジェクトの文脈を考慮**: CLAUDE.md のルールや既存のコーディングスタイルに照らして判断する
- **レビューのみ**: このスキルはレビュー結果の出力のみ行い、コードの修正は行わない

## Examples

### Example 1: フロントエンド機能のレビュー

```markdown
user: ヒートマップの実装をレビューして
assistant: [Skill: code-reviewer]
assistant: [git diff で変更ファイル特定]
assistant: [全ファイルを Read]
assistant:

## コードレビュー結果

### 1. バグ

#### BUG-1: タイムゾーンによる日付キーのずれ (severity: high)

**ファイル:** `frontend/src/features/dashboard/hooks/useHeatmapGrid/useHeatmapGrid.ts:54`

**問題:**
`toISOString().slice(0, 10)` は UTC の日付を返すが、
`today.setHours(0, 0, 0, 0)` はローカル時間で設定している。
JST (UTC+9) で深夜0〜9時の間にずれが生じる。

**修正案:**
ローカル日付でキーを生成するヘルパー関数を使用。

### 2. リファクタリング

（なし or 指摘事項）

### 3. OWASP セキュリティチェック

| チェック項目 | 結果 | 備考 |
|---|---|---|
| A03 インジェクション | OK | React JSX による自動エスケープ |
| ... | ... | ... |
```

### Example 2: バックエンド API のレビュー

```markdown
user: ワークアウトAPIのコードをレビューして
assistant: [Skill: code-reviewer]
assistant: [対象ファイルを Read]
assistant:

## コードレビュー結果

### 1. バグ

（指摘事項）

### 2. リファクタリング

#### REFACTOR-1: godocコメントの不足 (priority: high)

**ファイル:** `backend/handler/workout_handler.go`

**現状:** 公開関数にgodocコメントがない。

### 3. OWASP セキュリティチェック

| チェック項目 | 結果 | 備考 |
|---|---|---|
| A01 アクセス制御 | NG | ユーザーIDの検証が不足 |
| A03 インジェクション | OK | sqlcによるパラメータ化クエリ使用 |
| ... | ... | ... |
```

## Related Files

- `CLAUDE.md` - プロジェクトルール
- `frontend/CLAUDE.md` - フロントエンドルール
- `docs/architecture/clean-architecture.md` - バックエンドアーキテクチャ
- `docs/development/frontend-testing-strategy.md` - フロントエンドテスト戦略
