# Phase1.3: Redis + Session-based認証の実装

**作業日**: 2026-02-05
**担当**: Claude Code
**ステータス**: 完了

## 目的

whiskeyアプリケーションに認証機能を実装する。当初はJWT認証を予定していたが、以下の理由からRedis + Session-based認証に変更：

- **シンプルなWeb版のみ**: モバイルアプリ対応が不要なため、JWTの利点（ステートレス）は不要
- **セキュリティ最優先**: ログアウトの確実性、セッション無効化の容易さを重視
- **実装の簡潔さ**: Refresh Tokenの実装が不要、XSS/CSRF対策が容易

## 技術選定

### なぜRedis？

PostgreSQLではなくRedisをセッションストアに選定した理由：

1. **パフォーマンス**: インメモリ動作で超高速（セッション検証のたびにディスクI/O不要）
2. **TTL機能**: 自動期限切れ削除（PostgreSQLでは定期クリーンアップバッチが必要）
3. **セッション管理に特化**: そもそもセッションストアとして設計されている
4. **スケーラビリティ**: 将来的に複数サーバーでセッション共有が容易

## 実装計画

### 1. インフラ設定
- [ ] compose.ymlにRedisサービスを追加
- [ ] backend環境変数にREDIS_URLを追加
- [ ] Redisクライアントの初期化

### 2. Session Store実装
- [ ] `backend/infrastructure/auth/session_store.go`を作成
  - Create: セッション作成
  - Get: セッション検証
  - Delete: セッション削除
- [ ] `backend/infrastructure/auth/session_store_test.go`を作成

### 3. Middleware実装
- [ ] `backend/infrastructure/auth/middleware.go`を作成
  - Cookie検証
  - セッション検証
  - ユーザーIDをコンテキストに格納

### 4. UserHandler修正
- [ ] Login: セッション作成 + Cookie設定
- [ ] Logout: セッション削除 + Cookie削除（新規エンドポイント）

### 5. テスト
- [ ] Session Storeのユニットテスト
- [ ] Middlewareのユニットテスト
- [ ] 統合テスト（認証フロー全体）

## 作業内容

### 作業開始 - 計画立案

- Redis + Session-based認証の技術選定完了
- ユーザーとの確認: シンプルなWeb版のみ、セキュリティ最優先
- 実装計画を策定

### compose.yml修正完了

- Redisサービスをcompose.ymlに追加（redis:7-alpine）
- backend環境変数にREDIS_URL=redis:6379を追加
- redis-dataボリュームを追加
- Redisヘルスチェック設定完了

### Go依存関係の追加

- `github.com/redis/go-redis/v9 v9.17.3`をgo.modに追加
- `github.com/stretchr/testify v1.11.1`をテスト用に追加

### Session Store実装完了

- `backend/infrastructure/auth/session_store.go`を実装
  - Create(): セッション作成（UUIDベース、TTL対応）
  - Get(): セッション検証
  - Delete(): セッション削除
  - Extend(): セッションTTL延長
- `backend/infrastructure/auth/session_store_test.go`を実装
  - 7つのテストケース（Create, Get, Delete, Extend）

### Middleware実装完了

- `backend/infrastructure/auth/middleware.go`を実装
  - AuthMiddleware(): Cookieベースの認証ミドルウェア
  - GetUserIDFromContext(): コンテキストからユーザーID取得
- `backend/infrastructure/auth/middleware_test.go`を実装
  - 7つのテストケース（有効/無効/期限切れセッション）

### UserHandler修正完了

- `backend/interfaces/handler/user_handler.go`を修正
  - NewUserHandler()にsessionStoreとsessionTTLパラメータ追加
  - Login(): セッション作成 + HttpOnly Cookie設定
  - Logout(): セッション削除 + Cookie削除（新規エンドポイント）
- Cookie設定: HttpOnly=true, Secure=true, SameSite=Lax

### UserHandlerテスト更新

- `backend/interfaces/handler/user_handler_test.go`を更新
  - mockSessionStoreを実装
  - Login/Logoutのテストケースを追加（セッションCookie検証含む）
  - 既存テストにSessionStore依存性を追加

### Redisコンテナ起動

- docker compose up -d redisでRedisコンテナを起動
- ヘルスチェック成功確認

### Clean Architectureルール違反の修正

ユーザーからの重要な指摘を受けて、Clean Architectureに準拠した設計に修正：

**問題点:**
- UserHandler（Interfaces層）がSessionStore（Infrastructure層）に直接依存していた
- Interfaces層とInfrastructure層は同じレベルで、相互依存は禁止
- Usecase層をバイパスしてビジネスロジック（セッション管理）をHandlerが直接実行していた

**修正内容:**

1. **domain/repository/session_repository.go を作成**
   - SessionRepository interface を定義
   - Create, Get, Delete, Extend メソッド

2. **infrastructure/auth/session_store.go を修正**
   - repository.SessionRepository を実装することを明示
   - コンパイル時チェック追加

3. **usecase/user_usecase.go を修正**
   - SessionRepository と sessionTTL を依存性として追加
   - Login() を修正: セッションIDを返すように変更
   - Logout() を追加: セッション削除を実行
   - UserUsecaseInterface を更新

4. **usecase/user_usecase_test.go を修正**
   - mockSessionRepository を追加
   - 全ての NewUserUsecase 呼び出しに sessionRepo を追加
   - Login テストでセッションID検証を追加
   - Logout テストを追加

5. **interfaces/handler/user_handler.go を修正**
   - SessionStore への依存を削除
   - UserUsecase のみに依存するように変更
   - Login: Usecase からセッションIDを受け取り、Cookie設定のみ実行
   - Logout: Usecase でセッション削除、Cookie削除のみ実行

6. **interfaces/handler/user_handler_test.go を修正**
   - mockSessionStore を削除
   - mockUserUsecase に Login/Logout を追加
   - 全ての NewUserHandler 呼び出しから sessionStore を削除
   - テストケースを更新

7. **infrastructure/auth/middleware.go を修正**
   - AuthMiddleware の引数を repository.SessionRepository に変更
   - Infrastructure層が Domain層の interface に依存（正しい依存関係）

**アーキテクチャ改善:**
```
Handler（Interfaces層）
  ↓ 依存（外→内: OK）
Usecase層
  ↓ 依存（外→内: OK）
Domain層（SessionRepository interface）
  ↑ 実装（外→内: OK）
Infrastructure層（SessionStore実装）
```

**責務の明確化:**
- **Handler**: HTTPリクエスト/レスポンス、Cookie設定/削除
- **Usecase**: ビジネスロジック（認証、セッション管理）
- **Repository**: データ永続化（Redis操作）

## 変更ファイル（予定）

- `compose.yml` - Redisサービス追加
- `backend/go.mod` - go-redis/redis/v8追加
- `backend/infrastructure/auth/session_store.go` - 新規作成
- `backend/infrastructure/auth/session_store_test.go` - 新規作成
- `backend/infrastructure/auth/middleware.go` - 新規作成
- `backend/infrastructure/auth/middleware_test.go` - 新規作成
- `backend/interfaces/handler/user_handler.go` - Login/Logout修正
- `docs/task-dashboard.md` - Phase1.3の実装計画を更新

## 課題・Todo

- [ ] compose.ymlにRedis追加
- [ ] Session Store実装
- [ ] Middleware実装
- [ ] UserHandler修正
- [ ] テスト作成
- [ ] ドキュメント更新

## 備考

- Cookie設定: HttpOnly, Secure, SameSite=Lax
- セッション有効期限: 24時間（調整可能）
- Redisイメージ: redis:7-alpine

## 完了サマリー

### 実装内容

1. **インフラ設定**
   - compose.ymlにRedisサービス追加
   - go.modにredis/go-redis/v9追加

2. **Domain層**
   - repository.SessionRepository interface 作成

3. **Infrastructure層**
   - SessionStore 実装（repository.SessionRepository を実装）
   - Middleware 実装（SessionRepository に依存）
   - 統合テスト（Redis使用）

4. **Usecase層**
   - UserUsecase に SessionRepository 依存性追加
   - Login: セッション作成、セッションID返却
   - Logout: セッション削除
   - ユニットテスト（mockSessionRepository使用）

5. **Interfaces層**
   - UserHandler: Usecaseのみに依存（SessionStoreへの直接依存を削除）
   - Login: Cookie設定のみ担当
   - Logout: Cookie削除のみ担当
   - ユニットテスト更新

### 変更ファイル一覧

**新規作成:**
- `domain/repository/session_repository.go`
- `infrastructure/auth/session_store.go`
- `infrastructure/auth/session_store_test.go`
- `infrastructure/auth/middleware.go`
- `infrastructure/auth/middleware_test.go`

**修正:**
- `compose.yml`
- `backend/go.mod`
- `usecase/user_usecase.go`
- `usecase/user_usecase_test.go`
- `interfaces/handler/user_handler.go`
- `interfaces/handler/user_handler_test.go`

### アーキテクチャの改善

**修正前（❌ ルール違反）:**
```
Handler → Infrastructure (SessionStore)  ← 同じレベルの層同士が依存
Handler → Usecase
```

**修正後（✅ Clean Architecture準拠）:**
```
Handler → Usecase → Domain (interface) ← Infrastructure (実装)
```

### 次のステップ

Phase1.3は完了しましたが、実際にアプリケーションを動作させるには **Phase1.4（ルーティング設定）** が必要：

1. `backend/infrastructure/router/router.go` - ルーティング設定
2. `backend/cmd/api/main.go` - 依存関係の注入とサーバー起動
3. 統合テストの実行
